<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reservation">
	<select id="QID_SELECT_RESERVATION_CAPACITY_LIST" resultType="ReservationCapacityDto">
		SELECT
			reservation_capacity_no,
			reservation_capacity_dw,
			reservation_capacity_time,
			reservation_capacity_people
		FROM
			ym_reservation_capacity
		<where>
			<if test="reservation_capacity_dw != 'all'">
				AND reservation_capacity_dw = #{reservation_capacity_dw}
			</if>
		</where>
		ORDER BY
    		reservation_capacity_time asc
	</select>
	
	<select id="QID_SELECT_RESERVATION_CAPACITY" resultType="ReservationCapacityDto">
		SELECT
			reservation_capacity_no,
			reservation_capacity_dw,
			reservation_capacity_time,
			reservation_capacity_people
		FROM
			ym_reservation_capacity
		<where>
			<if test="reservation_capacity_no != null and reservation_capacity_no != ''">
				AND reservation_capacity_no = #{reservation_capacity_no}
			</if>
			<if test="reservation_capacity_time != null and reservation_capacity_time != ''">
				AND reservation_capacity_time = #{reservation_capacity_time}
			</if>
		</where>
	</select>
	
	<insert id="QID_INSERT_RESERVATION_CAPACITY">
		INSERT INTO ym_reservation_capacity (
			reservation_capacity_no,
			reservation_capacity_dw,
			reservation_capacity_time,
			reservation_capacity_people
		) VALUES (
			ym_reservation_capacity_no_seq.nextval,
			#{reservation_capacity_dw},
			#{reservation_capacity_time},
			#{reservation_capacity_people}
		)
	</insert>
	
	<update id="QID_UPDATE_RESERVATION_CAPACITY">
		UPDATE ym_reservation_capacity
		SET
			reservation_capacity_dw = #{reservation_capacity_dw},
			reservation_capacity_time = #{reservation_capacity_time},
			reservation_capacity_people = #{reservation_capacity_people}
		WHERE
			reservation_capacity_no = #{reservation_capacity_no}
	</update>
	
	<delete id="QID_DELETE_RESERVATION_CAPACITY">
		DELETE
			ym_reservation_capacity
		WHERE
			reservation_capacity_no = #{reservation_capacity_no}
	</delete>
	
	<select id="QID_SELECT_RESERVATION_LIST" resultType="ReservationDto">
		SELECT
			r.*,
			u.user_name,
			(SELECT
				COUNT(*)
			FROM
				ym_reservation_product rp
			WHERE
				rp.reservation_no = r.reservation_no) AS product_total_cnt,
			(SELECT
				SUM(p.product_price)
			FROM
				ym_reservation_product rp,
				ym_product p
			WHERE
				rp.product_no = p.product_no
				AND rp.reservation_no = r.reservation_no) AS product_sum_price
		FROM
			ym_reservation r,
			ym_user u
		WHERE
			r.user_no = u.user_no
		ORDER BY
    		reservation_time ASC
	</select>
	
	<select id="QID_SELECT_RESERVATION" resultType="ReservationDto">
		SELECT
			r.*,
			u.user_name,
			(SELECT
				COUNT(*)
			FROM
				ym_reservation_product rp
			WHERE
				rp.reservation_no = r.reservation_no) AS product_total_cnt,
			(SELECT
				SUM(p.product_price)
			FROM
				ym_reservation_product rp,
				ym_product p
			WHERE
				rp.product_no = p.product_no
				AND rp.reservation_no = r.reservation_no) AS product_sum_price
		FROM
			ym_reservation r,
			ym_user u
		WHERE
			r.user_no = u.user_no
			and reservation_no = #{reservation_no}
	</select>
	
	<select id="QID_SELECT_RESERVATION_NO_SEQ" resultType="Integer">
		SELECT
			ym_reservation_no_seq.nextval
		FROM
			dual
	</select>
	
	<insert id="QID_INSERT_RESERVATION">
		INSERT INTO ym_reservation (
			reservation_no,
			reservation_people,
			reservation_comment,
			reservation_time,
			user_no
		) VALUES (
			#{reservation_no},
			#{reservation_people},
			#{reservation_comment},
			TO_DATE(#{reservation_time}, 'yyyy/mm/dd hh24:mi:ss'),
			#{user_no}
		)
	</insert>
	
	<update id="QID_UPDATE_RESERVATION">
		UPDATE ym_reservation
		SET
			reservation_people = #{reservation_people},
			reservation_comment = #{reservation_comment},
			reservation_time = TO_DATE(#{reservation_time}, 'yyyy/mm/dd hh24:mi:ss')
		WHERE
			reservation_no = #{reservation_no}
	</update>
	
	<delete id="QID_DELETE_RESERVATION">
		DELETE
			ym_reservation
		WHERE
			reservation_no = #{reservation_no}
	</delete>
	
	<insert id="QID_INSERT_RESERVATION_PRODUCT">
		INSERT INTO ym_reservation_product (
			reservation_no,
			product_no,
			product_cnt
		) VALUES (
			#{reservation_no},
			#{product_no},
			#{product_cnt}
		)
	</insert>
	
	<select id="QID_SELECT_RESERVATION_PRODUCT_LIST" resultType="ReservationProductDto">
		SELECT
			r.reservation_no,
			pc.product_category_no,
			pc.product_category_name,
			p.product_no,
			p.product_name,
			p.product_price,
			rp.product_cnt
		FROM
			ym_reservation r,
			ym_reservation_product rp,
			ym_product p,
			ym_product_category pc
		WHERE
			r.reservation_no = rp.reservation_no
			AND rp.product_no = p.product_no
			AND p.product_category_no = pc.product_category_no
			AND r.reservation_no = #{reservation_no}
		ORDER BY
			pc.product_category_order_by ASC,
			p.product_order_by ASC
	</select>
	
	<select id="QID_SELECT_RESERVATION_PEOPLE" resultType="ReservationDto">
		SELECT
			to_char(reservation_time,'YYYY-MM-DD HH:MI') AS reservation_time_format,
			reservation_people
		FROM
			ym_reservation
	</select>
</mapper>